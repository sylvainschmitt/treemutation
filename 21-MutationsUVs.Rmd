```{r setupuvs, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(ape)
library(phangorn)
library(ggtree)
library(rstan)
library(rstanarm)
library(bayesplot)
theme_set(bayesplot::theme_default())
options(mc.cores = 4)
rstan_options(auto_write = TRUE)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
```


# Mutations & UVs

> Effects  of  UV  light  on  mutation  rates (T4.4): We  will  test  the  hypothesis  that  sunlight  enhances  the accumulation of mutation by comparing the number of mutations per physical branch meter in high and low light exposure branches and will compare mutation rates across species. Appropriate accounting for differences in light environment will be done based on modelling of light environment (T2.3) anddirect measurements of sunlight (T2.6).

## *in silico*

Let's generate a tree from 10 branch tips belonging to 5 branches with varying physical distances in meters.
We can simulate for each tip a transmittance value calibrated on the data from Angela (`Transmittance_exact_Att_correc.txt`).
We can simulate a number of mutations $N$ for each $tip$ based on the $transmittance$ and the total branch $length$ (Fig. \@ref(fig:insilicomutuvsplot)).

Let's detect back the effect of light on the number of mutations.
For that we will use two models with a Poisson distribution associated to a log link inferring the light influence either (1) as a fixed effect or (2) as a covariate with the transmittance value:

$$N_{tip,light} \sim \mathcal Plog (N_0 + \beta_1 . length_{tip}) ~(Null)$$

$$N_{tip,light} \sim \mathcal Plog (N_0 + N_{light} + \beta_1 . length_{tip}) ~(Fix)$$

$$N_{tip} \sim \mathcal Plog (N_0 + \beta_1 . length_{tip} + \beta_2 . transmittance_{tip}) ~(Cov)$$

Interestingly, the effect of the total branch length is always confounded with the intercept in my simulations (Fig. \@ref(fig:insilicoreg)).
Nevertheless, the models were able to identify the effect of light and transmittance but with high uncertainty (non-significant) despite a strong simulated effect.
Indeed, the confounding effect of branch length is complicated to decipher with this very low sample size.

I further used a second approach focused on branch length between architecture and phylogeny.
The idea is that if we try to relate phylogenetic distance to architectural distance,
the tips exposed to light should show a higher coefficient due to their faster substitution per branch meter (Fig. \@ref(fig:insilicomutuvsplot2)).
This model could also be quickly accommodated to include the effect of transmittance that should increase the slope (substitution per site per branch meter).

```{r insilicomutuvs}
transmittance0 <- read_tsv("data/lidar_olivier/files/Transmittance_exact_Att_correc.txt") %>% 
  mutate(tip = paste0(ID, "_", Condition)) %>% 
  filter(!(tip %in% c("B1_L", "B4_L"))) %>% 
  group_by(Condition) %>% 
  summarise(m = mean(Transmittance), s = sd(Transmittance))
n_branches <- 5
tips <- c("L", "O")
N0 <- 10
beta1 <- 1
beta2 <- 50
archi <- rtree(n_branches, tip.label = paste0("B", 1:n_branches))
branches <- archi$tip.label
for(b in branches){
  archi <- add.tips(archi, paste0(b, "_L"), b, edge.length = abs(rnorm(1, mean(archi$edge.length)/1, sd(archi$edge.length)/1)))
  archi <- add.tips(archi, paste0(b, "_O"), b, edge.length = abs(rnorm(1, mean(archi$edge.length)/1, sd(archi$edge.length)/1)))
  archi <- drop.tip(archi, b)
}
archi$edge.length <- archi$edge.length * (1/0.06)
length <- adephylo::distRoot(archi, method = "patristic")
isdata <- data.frame(tip = names(length), length = length) %>% 
  separate(tip, c("branch", "light"), remove = F) %>% 
  rowwise() %>% 
  mutate(transmittance = ifelse(light == transmittance0$Condition[1], 
                                rnorm(1, transmittance0$m[1], transmittance0$s[1]), 
                                rnorm(1, transmittance0$m[2], transmittance0$s[2]))) %>% 
  ungroup() %>% 
  mutate(lightnum = ifelse(light == "O", 1, 2), branchnum = as.numeric(gsub("B", "", branch))) %>% 
  mutate(mu = N0 + beta1*length + beta2*transmittance) %>%
  mutate(N = round(mu))
```

```{r insilicomutuvsplot, fig.cap="Simulated archtiecture with varying number of mutations depending on branch total length and transmittance."}
cowplot::plot_grid(
  phylobase::phylo4d(archi, tip.data = isdata) %>% 
    ggtree(right = T) +
    geom_tiplab(offset = 1) +
    geom_tippoint(aes(color = transmittance, size = N)) +
    xlim(0, max(isdata$length)+5) +
    ggtitle("Architecture (m)", paste("N0 =",  N0, ", beta1 =", beta1, "(length), beta2 =", beta2, "(transmittance)")) +
    theme_tree2() +
    viridis::scale_color_viridis("Transmittance", option = "B") +
    scale_size_continuous("Number of mutations") +
    theme(legend.position = "right"),
  isdata %>% 
    dplyr::select(tip, light, N, length, transmittance) %>% 
    reshape2::melt(c("tip", "light")) %>% 
    mutate(variable = recode(variable, 
                             "length" = "Branch total length (m)",
                             "transmittance" = "Transmittance", 
                             "N" = "Number of mutations")) %>% 
    mutate(variable = factor(variable, levels = c("Branch total length (m)", "Transmittance", "Number of mutations"))) %>% 
    ggplot(aes(light, value, fill = light)) +
    geom_boxplot(col = "grey") +
    facet_wrap(~ variable, scales = "free", nrow = 3) +
    theme(legend.position = "bottom",
      axis.line.y = element_blank(), axis.ticks.y = element_blank(),
          axis.title = element_blank(), axis.text.y = element_blank()) +
    viridis::scale_fill_viridis(discrete = T, direction = -1, option = "B") +
    coord_flip(),
  rel_widths = c(3,1)
)
```

```{r insilicoregrun, include=FALSE}
m_null <- stan_glm(N ~ length, data = isdata, family = poisson, chains = 2, show_messages = F)
m_fix <- stan_glm(N ~ length + light, data = isdata, family = poisson, chains = 2, show_messages = F)
m_cov <- stan_glm(N ~ length + transmittance, data = isdata, family = poisson, chains = 2, show_messages = F)
```

```{r insilicoregplot, fig.cap="Results of linear regression with a Poisson-log model for the simulated data."}
cowplot::plot_grid(
  mcmc_intervals(m_null),
  mcmc_intervals(m_fix),
  mcmc_intervals(m_cov),
  labels = c("Null", "Fix", "Cov"),
  nrow = 3
) 
```

```{r insilicomutuvs2, include=FALSE}
n_branches <- 5
increase <- 1.2 # %
archi <- rtree(n_branches, tip.label = paste0("B", 1:n_branches))
branches <- archi$tip.label
archi$edge.length <- archi$edge.length * (1/0.06)
for(b in branches){
  length <- 
  archi <- add.tips(archi, paste0(b, "_L"), b, edge.length = abs(rnorm(1, mean(archi$edge.length)*increase, sd(archi$edge.length))))
  archi <- add.tips(archi, paste0(b, "_O"), b, edge.length = abs(rnorm(1, mean(archi$edge.length)*increase, sd(archi$edge.length))))
  archi <- drop.tip(archi, b)
}
phylo <- archi
phylo$edge.length <- phylo$edge.length * 0.06 + abs(rnorm(length(phylo$edge.length), 0, 10^-2))
phylo$edge.length[
  sapply(which(phylo$tip.label %in% paste0(paste0("B", 1:n_branches), "_L")),
                         function(x,y) which(y == x), y = phylo$edge[,2])
  ] <- phylo$edge.length[
  sapply(which(phylo$tip.label %in% paste0(paste0("B", 1:n_branches), "_L")),
                         function(x,y) which(y == x), y = phylo$edge[,2])
  ] * increase
lengths <- lapply(c(archi = archi, phylo = phylo), 
                  function(x)
                    data.frame(
                      length = adephylo::distRoot(x, method = "patristic")) %>% 
                    rownames_to_column("tip")) %>% 
  bind_rows(.id = "tree") %>% 
  reshape2::dcast(tip ~ tree) %>% 
  separate(tip, c("branch", "Condition"), remove = F)
reg <- stan_glm(phylo ~ Condition + archi, data = lengths, family="gaussian", chains = 2, show_messages = F) 
```

```{r insilicomutuvsplot2, fig.cap="Simulated archtiecture and phylogeny with varying length depending on light exposure."}
cowplot::plot_grid(
  phylobase::phylo4d(archi, tip.data = data.frame(
    length = adephylo::distRoot(archi, method = "patristic")) %>% 
      rownames_to_column("tip")) %>% 
    ggtree(right = T) +
    geom_tiplab(offset = 1) +
    geom_tippoint(aes(color = length), size = 3) +
    theme_tree2() +
    ggtitle("Architecture (m)") +
    viridis::scale_color_viridis("Total length", option = "B") +
    theme(legend.position = "right") +
    xlim(0, 50),
  phylobase::phylo4d(phylo, tip.data = data.frame(
    length = adephylo::distRoot(phylo, method = "patristic")) %>% 
      rownames_to_column("tip")) %>% 
    ggtree(right = T) +
    geom_tiplab(offset = 0.1) +
    geom_tippoint(aes(color = length), size = 3) +
    theme_tree2() +
    ggtitle("Phylogeny (subtitutions per site)") +
    viridis::scale_color_viridis("Total length", option = "B") +
    theme(legend.position = "right") +
    xlim(0, 3),
  ggplot(lengths, aes(archi, phylo, col = Condition)) +
    geom_point() +
    geom_smooth(method = "lm") +
    xlab("Architecture distance") +
    ylab("Phylogeny distance") +
    viridis::scale_color_viridis(direction = -1, discrete = T, option = "B"),
  mcmc_intervals(reg),
  nrow = 2
)
```

## Angela

### Transmittance & Accupar

```{r angelaDataUV}
rm(list = ls())
angela <- 
  "((((AS:3.83,AL:6.04)A:6.44,(BS:3.34,BL:10.64)B:1.6)AB:6.5,((CS:3.8,CL:5.13)C:14.45,(DS:3.5,DL:7.76)D:6.2)CD:1.7,(ES:0,EL:2.2)E:3.7)XE:26.5)T:1.3;"
angela <- read.tree(text = angela)
par <- read_tsv("data/mutations/angela/Angela - phylodata.tsv") %>% 
  rowwise() %>% 
  mutate(par = mean(c(par1, par2, par3))) %>% 
  mutate(branch = str_sub(tip, 1, 1)) %>% 
  mutate(condition = str_sub(tip, 2, 2)) 
```

```{r}
cowplot::plot_grid(
  ggplot(par, aes(par, transmittance, col = condition, group = NA)) +
    ggpubr::stat_cor() +
    geom_point() +
    ggrepel::geom_text_repel(aes(label = branch)) +
    geom_smooth(method = "lm", se = F) +
    xlab("Field transmittance (PAR)") + ylab("LiDAR transmittance"),
  par %>% 
    dplyr::select(branch, condition, par, transmittance) %>% 
    reshape2::melt(c("branch", "condition")) %>% 
    reshape2::dcast(branch ~ condition + variable) %>% 
    mutate(dpar = L_par - S_par, dtransmittance = L_transmittance - S_transmittance) %>% 
    ggplot(aes(dpar, dtransmittance)) +
    ggpubr::stat_cor() +
    geom_point() +
    ggrepel::geom_text_repel(aes(label = branch)) +
    geom_smooth(method = "lm", se = F) +
    xlab("Difference in field transmittance (PAR)") + ylab("Difference in LiDAR transmittance")
) 
```

```{r}
cowplot::plot_grid(
  phylobase::phylo4d(angela, tip.data = par) %>% 
    ggtree(right = T) +
    geom_tiplab(offset = 1) +
    geom_tippoint(aes(color = par), size = 3) +
    theme_tree2() +
    viridis::scale_color_viridis("Field\ntransmittance\n(PAR)", option = "B") +
    theme(legend.position = "right") +
    xlim(0, 50),
  phylobase::phylo4d(angela, tip.data = par) %>% 
    ggtree(right = T) +
    geom_tiplab(offset = 1) +
    geom_tippoint(aes(color = transmittance), size = 3) +
    theme_tree2() +
    viridis::scale_color_viridis("LiDAR\ntransmittance", option = "B") +
    theme(legend.position = "right") +
    xlim(0, 50),
  nrow = 2
) 
```

### Phylogeny and light

```{r }
phylo <- ape::read.tree("data/mutations/angela/trees/tips/base2.min4.fa.treefile")
archi <- 
  "((((AS:3.83,AL:6.04)A:6.44,(BS:3.34,BL:10.64)B:1.6)AB:6.5,((CS:3.8,CL:5.13)C:14.45,(DS:3.5,DL:7.76)D:6.2)CD:1.7,(ES:0,EL:2.2)E:3.7)XE:26.5)T:1.3;"
archi <- ape::read.tree(text = archi)
lengths <- lapply(c(archi = archi, phylo = phylo), 
                  function(x)
                    data.frame(
                      length = adephylo::distRoot(x, method = "patristic")) %>% 
                    rownames_to_column("tip")) %>% 
  bind_rows(.id = "tree") %>% 
  reshape2::dcast(tip ~ tree) %>% 
  mutate(branch = str_sub(tip, 1, 1), tip = str_sub(tip, 2, 2))

ggplot(lengths, aes(archi, phylo, col = tip)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Architecture distance") +
  ylab("Phylogeny distance") +
  viridis::scale_color_viridis(direction = -1, discrete = T, option = "B")  
```

### Phylogenetic distance

```{r}
mutations <- read.phyDat("data/mutations/angela/trees/tips/base2.min4.nexus", format = "nexus")
gd <- dist.hamming(mutations) %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column("library1") %>% 
  reshape2::melt("library1", variable.name = "library2", value.name = "genetic_distance")
light <- read_tsv("data/mutations/angela/Angela - phylodata.tsv") %>% 
  rowwise() %>% 
  mutate(par = mean(c(par1, par2, par3))) %>% 
  mutate(branch = str_sub(tip, 1, 1)) %>% 
  mutate(condition = str_sub(tip, 2, 2)) %>% 
  rename(library = tip) %>% 
  dplyr::select(library, transmittance, par)
transmittance <- light$transmittance
names(transmittance) <- light$library
td <- dist(transmittance) %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column("library1") %>% 
  reshape2::melt("library1", variable.name = "library2", value.name = "transmittance_distance")
par <- light$par
names(par) <- light$library
pd <- dist(par) %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column("library1") %>% 
  reshape2::melt("library1", variable.name = "library2", value.name = "par_distance")
gd %>% 
  left_join(td) %>% 
  left_join(pd) %>% 
  unique() %>% 
  reshape2::melt(c("library1", "library2", "genetic_distance")) %>% 
  ggplot(aes(genetic_distance, value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~ variable, scales = "free")  
```

### Mutation rate

```{r, fig.cap="Number of mutations per filter and light condition across branches."}
vroom::vroom("data/mutations/angela/filters/filtered_tip_mutations.tsv") %>% 
   group_by(tumor, branch, tip, Filter) %>%
  summarise(N = n()) %>%
  reshape2::dcast(branch + tip ~ Filter, value.var = "N") %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  mutate(base2 = base2 + base3 + evs2, evs2 = evs2 + evs3, base3 = base3 + evs3) %>% 
  reshape2::melt(c("branch", "tip"), variable.name = "filter", value.name = "mutations") %>% 
  mutate(condition = recode(tip, "L" = "Light", "S" = "Shadow")) %>% 
  ggplot(aes(filter, mutations, fill = condition)) +
  geom_boxplot() +
  scale_y_sqrt() +
  xlab("Filter") + ylab("Number of mutations") + scale_color_discrete("") 
```

```{r, fig.cap="Number of mutations per filter and light condition across branches."}
vroom::vroom("data/mutations/angela/filters/filtered_tip_mutations.tsv") %>% 
   group_by(tumor, branch, tip, Filter) %>%
  summarise(N = n()) %>%
  reshape2::dcast(branch + tip ~ Filter, value.var = "N") %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  mutate(base2 = base2 + base3 + evs2, evs2 = evs2 + evs3, base3 = base3 + evs3) %>% 
  mutate(library = paste0(branch, tip)) %>% 
  left_join(light) %>% 
  reshape2::melt(c("library", "branch", "tip", "transmittance", "par"), variable.name = "filter", value.name = "mutations") %>% 
  reshape2::melt(c("library", "branch", "tip", "filter", "mutations")) %>% 
  ggplot(aes(value, mutations, col = filter)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(~ variable, scales = "free_x") +
  scale_y_sqrt() 
```

### Mutation type

Mutations type per condition.

```{r, eval=F}
library(Biostrings)
library(genomeIntervals)
genome <- readDNAStringSet("data/mutations/angela/genome/Dgu_HS1_HYBRID_SCAFFOLD.fa")
genome_index <- read_tsv("data/mutations/angela/genome/Dgu_HS1_HYBRID_SCAFFOLD.fa.fai",
                         col_names = c("CHROM", "length", "bytesindex", "basesperline", "bytesperline")) %>% 
  dplyr::select(CHROM, length) %>% 
  mutate(start = 0, end = length) %>% 
  dplyr::select(-length)
mutations <- vroom::vroom("data/mutations/angela/filters/filtered_tip_mutations.tsv")
seqs <- lapply(1:nrow(mutations), function(i)
  as.character(unlist(extractAt(genome[mutations$CHROM[i]], IRanges(mutations$POS[i]-1, width=3)))))
t <- mutations %>% 
  mutate(spectra = unlist(seqs)) %>% 
  mutate(REF5 = str_sub(spectra, 1, 1), REFspectra = str_sub(spectra, 2, 2), REF3 = str_sub(spectra, 3, 3)) %>% 
  dplyr::select(-REFspectra) %>% 
  mutate(type = paste0(REF, "->", ALT)) %>% 
  mutate(strand = recode(type,
                         "G->T" = "-",
                         "C->A" = "+",
                         "G->C" = "-",
                         "C->G" = "+",
                         "G->A" = "-",
                         "C->T" = "+",
                         "A->T" = "-",
                         "T->A" = "+",
                         "A->G" = "-",
                         "T->C" = "+",
                         "A->C" = "-",
                         "T->G" = "+"
                       )) %>%
  mutate(type = recode(type,
                       "G->T" = "C->A",
                       "G->C" = "C->G",
                       "G->A" = "C->T",
                       "A->T" = "T->A",
                       "A->G" = "T->C",
                       "A->C" = "T->G"
  )) %>%
  mutate(POS5 = REF5, POS3 = REF3) %>% 
  mutate(POS5r = recode(POS5, "A" = "T", "T" = "A", "C" = "G", "G" = "C")) %>%
  mutate(REFr = recode(REF, "A" = "T", "T" = "A", "C" = "G", "G" = "C")) %>%
  mutate(POS3r = recode(POS3, "A" = "T", "T" = "A", "C" = "G", "G" = "C")) %>%
  mutate(POS5f = ifelse(strand == "+", POS5, POS3r)) %>%
  mutate(REFf = ifelse(strand == "+", REF, REFr)) %>%
  mutate(POS3f = ifelse(strand == "+", POS3, POS5r)) %>% 
  mutate(spectra = paste0(POS5f, REFf, POS3f)) %>% 
  dplyr::select(CHROM, POS, SNV, REF, ALT, tumor, branch, tip, mutation_AF, Filter, type, spectra)
write_tsv(t, "data/mutations/angela/filters/filtered_tip_mutations_spectra.tsv") 
```


```{r}
vroom::vroom("data/mutations/angela/filters/filtered_tip_mutations_spectra.tsv") %>% 
  filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = "Light", "S" = "Shadow")) %>% 
  mutate(sample = paste0(branch, tip)) %>% 
  group_by(type, sample, condition) %>% 
  summarise(N = n()) %>% 
  group_by(sample) %>% 
  ggplot(aes(type, N, fill = condition)) +
  geom_boxplot(position = "dodge") + 
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),
        axis.line.x = element_blank(), axis.ticks.x = element_blank(),
        legend.position = "bottom") +
  facet_wrap(~ type, nrow = 1, scales = "free_x") +
  xlab("Percentage of mutations (%) per sample") 
```


```{r mdatatype, eval=F}
light <- read_tsv("data/mutations/angela/Angela - phylodata.tsv") %>% 
  rowwise() %>% 
  mutate(par = mean(c(par1, par2, par3))) %>% 
  mutate(branch = str_sub(tip, 1, 1)) %>% 
  mutate(condition = str_sub(tip, 2, 2)) %>% 
  dplyr::rename(sample = tip) %>% 
  dplyr::select(sample, transmittance, par)
data <- vroom::vroom("data/mutations/angela/filters/filtered_tip_mutations_spectra.tsv") %>% 
  filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = 1, "S" = 0)) %>% 
  mutate(branchNum = as.numeric(as.factor(branch))) %>% 
  mutate(sample = paste0(branch, tip)) %>% 
  group_by(type, sample, condition) %>% 
  left_join(light) %>% 
  ungroup() 
rm(light)
mdata <- list(
  N = nrow(data),
  S = length(unique(data$type)),
  B = length(unique(data$branch)),
  Y = sapply(levels(as.factor(data$type)),
                  function(t) as.numeric(data$type == t)),
  light = data$condition,
  transmittance = data$transmittance,
  branch = data$branchNum,
  N_pred = 101,
  transmittance_pred = as.numeric(0:100)
)
```

$$M1:~~Presence~Mutation_{type,light,position}\sim\mathcal{Dirichlet~Multinomial}[softmax(\mu_{type}+\alpha_{light})]$$

```{r m1type, eval=F}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
m1 <- stan_model("model/m1.stan")
fit1 <- sampling(m1, chains = 2, mdata, save_warmup = F)
save(mdata, m1, fit1, file = "model/m1.Rdata")
```

```{r m1typeRes}
library(bayesplot)
load("model/m1.Rdata")
cowplot::plot_grid(
  mcmc_intervals(fit1, regex_pars = "mu") +
    ggtitle(paste0(1:6, ": ", colnames(mdata$Y), collapse = ", ")),
  mcmc_intervals(fit1, regex_pars = "alpha") +
    ggtitle("")
) 
```

$$M2:~~Presence~Mutation_{type,tip,position}\sim\mathcal{Dirichlet~Multinomial}[softmax(\mu_{type}+\beta*transmittance_{tip})]$$

```{r m2type, eval=F}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
m2 <- stan_model("model/m2.stan")
fit2 <- sampling(m2, chains = 2, mdata, save_warmup = F)
save(mdata, m2, fit2, file = "model/m2.Rdata")
```

```{r m2typeRes}
library(bayesplot)
load("model/m2.Rdata")
# mcmc_trace(fit2)
# mcmc_pairs(fit1)
cowplot::plot_grid(
  mcmc_intervals(fit2, regex_pars = "mu") +
    ggtitle(paste0(1:6, ": ", colnames(mdata$Y), collapse = ", ")),
  mcmc_intervals(fit2, regex_pars = "alpha") +
    ggtitle("")
) 
```

### Mutation spectra

Mutations spectra per condition.

```{r, fig.width=12}
vroom::vroom("data/mutations/angela/filters/filtered_tip_mutations_spectra.tsv") %>% 
    filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = "Light", "S" = "Shadow")) %>% 
  mutate(sample = paste0(branch, tip)) %>% 
  group_by(spectra) %>% 
  group_by(type, spectra, sample, condition) %>% 
  summarise(N = n()) %>% 
  ggplot(aes(spectra, N, fill = condition)) +
  geom_boxplot(position = "dodge") + 
  facet_wrap(~ type, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom", axis.title.x = element_blank()) +
  theme(panel.spacing = unit(0, "lines"), panel.border = element_rect(size = 0.25, color = "black", fill = NA)) +
  ylab("Percentage of mutations (%) per sample") +
  scale_y_log10()
```


```{r mdataspectra}
light <- read_tsv("data/mutations/angela/Angela - phylodata.tsv") %>% 
  rowwise() %>% 
  mutate(par = mean(c(par1, par2, par3))) %>% 
  mutate(branch = str_sub(tip, 1, 1)) %>% 
  mutate(condition = str_sub(tip, 2, 2)) %>% 
  dplyr::rename(sample = tip) %>% 
  dplyr::select(sample, transmittance, par)
data <- vroom::vroom("data/mutations/angela/filters/filtered_tip_mutations_spectra.tsv") %>% 
  filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = 1, "S" = 0)) %>% 
  mutate(branchNum = as.numeric(as.factor(branch))) %>% 
  mutate(sample = paste0(branch, tip)) %>% 
  group_by(type, sample, condition) %>% 
  left_join(light) %>% 
  ungroup() 
rm(light)
mdata <- list(
  N = nrow(data),
  S = length(unique(data$spectra)),
  B = length(unique(data$branch)),
  Y = sapply(levels(as.factor(data$spectra)),
                  function(t) as.numeric(data$spectra == t)),
  light = data$condition,
  transmittance = data$transmittance,
  branch = data$branchNum,
  N_pred = 101,
  transmittance_pred = as.numeric(0:100)
)
```

```{r n1spectra, eval=F}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
n1 <- stan_model("model/n1.stan")
fit1 <- sampling(n1, chains = 2, mdata, save_warmup = F)
save(mdata, n1, fit1, file = "model/n1.Rdata")
```

```{r m1spectraRes, fig.width=10}
library(bayesplot)
load("model/n1.Rdata")
cowplot::plot_grid(
  mcmc_intervals(fit1, regex_pars = "mu") +
    ggtitle(paste0(1:length(colnames(mdata$Y)), ": ", colnames(mdata$Y), collapse = ", ")),
  mcmc_intervals(fit1, regex_pars = "alpha") +
    ggtitle("")
) 
```

## Sixto

### Phylogeny and light

```{r }
phylo <- ape::read.tree("data/mutations/sixto/trees/tips/base2.min4.fa.treefile")
archi <- "(((((B1L:5.2,(C3L:4.47, C1S:0.75)C:0.4)XC:3.08,(E2L:3.8, E4S:3.5)E:1.6)XE:0.6,F2S:4.37)XF:1.6,(I1L:3.3, I2S:1.15)I:1.1)XI:28.64)T:1.3;"
archi <- ape::read.tree(text = archi)
lengths <- lapply(c(archi = archi, phylo = phylo), 
                  function(x)
                    data.frame(
                      length = adephylo::distRoot(x, method = "patristic")) %>% 
                    rownames_to_column("tip")) %>% 
  bind_rows(.id = "tree") %>% 
  reshape2::dcast(tip ~ tree) %>% 
  mutate(branch = str_sub(tip, 1, 2), tip = str_sub(tip, 3, 3))
ggplot(lengths, aes(archi, phylo, col = tip)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Architecture distance") +
  ylab("Phylogeny distance") +
  viridis::scale_color_viridis(direction = -1, discrete = T, option = "B")  
```

### Phylogenetic distance

```{r}
mutations <- read.phyDat("data/mutations/sixto/trees/tips/base2.min4.nexus", format = "nexus")
gd <- dist.hamming(mutations) %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column("library1") %>% 
  reshape2::melt("library1", variable.name = "library2", value.name = "genetic_distance")
light <- read_tsv("data/mutations/sixto/Sixto - phylodata.tsv") %>% 
  mutate(branch = str_sub(tip, 1, 2)) %>% 
  mutate(condition = str_sub(tip, 3, 3)) %>% 
  dplyr::rename(library = tip) %>% 
  dplyr::select(library, par)
par <- light$par
names(par) <- light$library
pd <- dist(par) %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column("library1") %>% 
  reshape2::melt("library1", variable.name = "library2", value.name = "par_distance")
gd %>% 
  left_join(pd) %>% 
  ggplot(aes(genetic_distance, par_distance)) +
  geom_point()
```

### Mutation rate

```{r, fig.cap="Number of mutations per filter and light condition across branches."}
vroom::vroom("data/mutations/sixto/filters/filtered_tip_mutations.tsv") %>% 
   group_by(tumor, branch, tip, Filter) %>%
  summarise(N = n()) %>%
  reshape2::dcast(branch + tip ~ Filter, value.var = "N") %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  mutate(base2 = base2 + base3 + evs2, evs2 = evs2 + evs3, base3 = base3 + evs3) %>% 
  reshape2::melt(c("branch", "tip"), variable.name = "filter", value.name = "mutations") %>% 
  mutate(condition = recode(tip, "L" = "Light", "S" = "Shadow")) %>% 
  ggplot(aes(filter, mutations, fill = condition)) +
  geom_boxplot() +
  scale_y_sqrt() +
  xlab("Filter") + ylab("Number of mutations") + scale_color_discrete("") 
```

```{r, fig.cap="Number of mutations per filter and light condition across branches."}
vroom::vroom("data/mutations/sixto/filters/filtered_tip_mutations.tsv") %>% 
   group_by(tumor, branch, tip, Filter) %>%
  summarise(N = n()) %>%
  reshape2::dcast(branch + tip ~ Filter, value.var = "N") %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  mutate(base2 = base2 + base3 + evs2, evs2 = evs2 + evs3, base3 = base3 + evs3) %>% 
  mutate(library = paste0(branch, tip)) %>% 
  left_join(light) %>% 
  reshape2::melt(c("library", "branch", "tip", "par"), variable.name = "filter", value.name = "mutations") %>% 
  ggplot(aes(par, mutations, col = filter)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  scale_y_sqrt() 
```

### Mutation type

Mutations type per condition.

```{r, eval=F}
library(Biostrings)
library(genomeIntervals)
genome <- readDNAStringSet("data/mutations/sixto/genome/HS1_Sru_omap1_hap1_HYBRID_SCAFFOLD.fa")
genome_index <- read_tsv("data/mutations/sixto/genome/HS1_Sru_omap1_hap1_HYBRID_SCAFFOLD.fa.fai",
                         col_names = c("CHROM", "length", "bytesindex", "basesperline", "bytesperline")) %>% 
  dplyr::select(CHROM, length) %>% 
  mutate(start = 0, end = length) %>% 
  dplyr::select(-length)
mutations <- vroom::vroom("data/mutations/sixto/filters/filtered_tip_mutations.tsv")
seqs <- lapply(1:nrow(mutations), function(i)
  as.character(unlist(extractAt(genome[mutations$CHROM[i]], IRanges(mutations$POS[i]-1, width=3)))))
t <- mutations %>% 
  mutate(spectra = unlist(seqs)) %>% 
  mutate(REF5 = str_sub(spectra, 1, 1), REFspectra = str_sub(spectra, 2, 2), REF3 = str_sub(spectra, 3, 3)) %>% 
  dplyr::select(-REFspectra) %>% 
  mutate(type = paste0(REF, "->", ALT)) %>% 
  mutate(strand = recode(type,
                         "G->T" = "-",
                         "C->A" = "+",
                         "G->C" = "-",
                         "C->G" = "+",
                         "G->A" = "-",
                         "C->T" = "+",
                         "A->T" = "-",
                         "T->A" = "+",
                         "A->G" = "-",
                         "T->C" = "+",
                         "A->C" = "-",
                         "T->G" = "+"
                       )) %>%
  mutate(type = recode(type,
                       "G->T" = "C->A",
                       "G->C" = "C->G",
                       "G->A" = "C->T",
                       "A->T" = "T->A",
                       "A->G" = "T->C",
                       "A->C" = "T->G"
  )) %>%
  mutate(POS5 = REF5, POS3 = REF3) %>% 
  mutate(POS5r = recode(POS5, "A" = "T", "T" = "A", "C" = "G", "G" = "C")) %>%
  mutate(REFr = recode(REF, "A" = "T", "T" = "A", "C" = "G", "G" = "C")) %>%
  mutate(POS3r = recode(POS3, "A" = "T", "T" = "A", "C" = "G", "G" = "C")) %>%
  mutate(POS5f = ifelse(strand == "+", POS5, POS3r)) %>%
  mutate(REFf = ifelse(strand == "+", REF, REFr)) %>%
  mutate(POS3f = ifelse(strand == "+", POS3, POS5r)) %>% 
  mutate(spectra = paste0(POS5f, REFf, POS3f)) %>% 
  dplyr::select(CHROM, POS, SNV, REF, ALT, tumor, branch, tip, mutation_AF, Filter, type, spectra)
write_tsv(t, "data/mutations/sixto/filters/filtered_tip_mutations_spectra.tsv")
save(seqs, file = "data/mutations/sixto/filters/seqs.Rdata")
```


```{r}
vroom::vroom("data/mutations/sixto/filters/filtered_tip_mutations_spectra.tsv") %>% 
  filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = "Light", "S" = "Shadow")) %>% 
  mutate(sample = paste0(branch, tip)) %>% 
  group_by(type, sample, condition) %>% 
  summarise(N = n()) %>% 
  ggplot(aes(type, N, fill = condition)) +
  geom_boxplot(position = "dodge") + 
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),
        axis.line.x = element_blank(), axis.ticks.x = element_blank(),
        legend.position = "bottom") +
  facet_wrap(~ type, nrow = 1, scales = "free_x") +
  xlab("Percentage of mutations (%) per sample") 
```


```{r mdatatypeSixto, eval=F}
data <- vroom::vroom("data/mutations/sixto/filters/filtered_tip_mutations_spectra.tsv") %>% 
  filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = 1, "S" = 0)) %>% 
  mutate(branchNum = as.numeric(as.factor(branch))) %>% 
  mutate(sample = paste0(branch, tip)) %>% 
  group_by(type, sample, condition) %>% 
  ungroup() 
mdata <- list(
  N = nrow(data),
  S = length(unique(data$type)),
  B = length(unique(data$branch)),
  Y = sapply(levels(as.factor(data$type)),
                  function(t) as.numeric(data$type == t)),
  light = data$condition,
  branch = data$branchNum,
  N_pred = 101
)
```

$$M1:~~Presence~Mutation_{type,light,position}\sim\mathcal{Dirichlet~Multinomial}[softmax(\mu_{type}+\alpha_{light})]$$

```{r m1typeSixto, eval=F}
library(cmdstanr)
m1 <- cmdstan_model("model/m1.stan")
fit1 <- m1$sample(chains = 2, parallel_chains = 2, mdata, refresh = 200, save_warmup = F)
fit1 <- rstan::read_stan_csv(fit1$output_files())
save(mdata, m1, fit1, file = "model/m1Sixto.Rdata")
```

```{r m1typeResSixto}
library(bayesplot)
load("model/m1Sixto.Rdata")
cowplot::plot_grid(
  mcmc_intervals(fit1, regex_pars = "mu") +
    ggtitle(paste0(1:6, ": ", colnames(mdata$Y), collapse = ", ")),
  mcmc_intervals(fit1, regex_pars = "alpha") +
    ggtitle("")
) 
```

### Mutation spectra

Mutations spectra per condition.

```{r, fig.width=12}
vroom::vroom("data/mutations/sixto/filters/filtered_tip_mutations_spectra.tsv") %>% 
  filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = "Light", "S" = "Shadow")) %>% 
  mutate(sample = paste0(branch, tip)) %>% 
  group_by(spectra) %>% 
  group_by(type, spectra, sample, condition) %>% 
  summarise(N = n()) %>% 
  filter(N > 0) %>% 
  group_by(spectra) %>% 
  filter(sum(N) > 20) %>% 
  ggplot(aes(spectra, N, fill = condition)) +
  geom_boxplot(position = "dodge") + 
  facet_wrap(~ type, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom", axis.title.x = element_blank()) +
  theme(panel.spacing = unit(0, "lines"), panel.border = element_rect(size = 0.25, color = "black", fill = NA)) +
  ylab("Percentage of mutations (%) per sample")
```

```{r mdataspectraSixto}
data <- vroom::vroom("data/mutations/sixto/filters/filtered_tip_mutations_spectra.tsv") %>% 
  filter(!(Filter %in% c("base1", "evs1"))) %>% 
  mutate(condition = recode(tip, "L" = 1, "S" = 0)) %>% 
  mutate(branchNum = as.numeric(as.factor(branch))) %>% 
  mutate(sample = paste0(branch, tip))
mdata <- list(
  N = nrow(data),
  S = length(unique(data$spectra)),
  B = length(unique(data$branch)),
  Y = sapply(levels(as.factor(data$spectra)),
                  function(t) as.numeric(data$spectra == t)),
  light = data$condition,
  branch = data$branchNum,
  N_pred = 101,
  transmittance_pred = as.numeric(0:100)
)
```

```{r n1spectraSixto, eval=F}
library(cmdstanr)
n1 <- cmdstan_model("model/n1.stan")
fit1 <- n1$sample(chains = 2, parallel_chains = 2, mdata, refresh = 200, save_warmup = F)
fit1 <- rstan::read_stan_csv(fit1$output_files())
save(mdata, n1, fit1, file = "model/n1Sixto.Rdata")
```

```{r m1spectraResSixto, fig.width=10}
library(bayesplot)
load("model/n1Sixto.Rdata")
cowplot::plot_grid(
  mcmc_intervals(fit1, regex_pars = "mu") +
    ggtitle(paste0(1:length(colnames(mdata$Y)), ": ", colnames(mdata$Y), collapse = ", ")),
  mcmc_intervals(fit1, regex_pars = "alpha") +
    ggtitle("")
) 
```
